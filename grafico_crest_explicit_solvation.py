import numpy as np
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt

HARTREE_TO_EV = 27.211386245988
KB_HARTREE_PER_K = 3.166811563e-6
T = 298.15
kT = KB_HARTREE_PER_K * T

# --- Input data (DFT-optimised energies + TDDFT singlet excitations)

gas = [
    dict(E=-307.34304880086586,
         exc=[0.31658887280271064,0.3350398754232705,0.347803871334532,0.35197512391101377,0.3616161717025967,0.3680778182274263,0.37091366072863974,0.3734866036750439,0.37557407653614105,0.3852501305411447],
         f=[0.0022146857579604167,0.0025078011210199706,0.015071024800091102,0.03928611468644612,0.04278584443364754,0.1045945145871245,0.03287718492471316,0.07483518310540589,0.19656213673335712,0.004412621815843111]),
    dict(E=-307.33934212233027,
         exc=[0.30620930355767634,0.3259579049241354,0.3449107146844889,0.3522297966161824,0.35405939281103455,0.3677000006599463,0.36876236048870853,0.37118377107950823,0.37515216159252474,0.37901701968629015],
         f=[0.002188619127090364,0.001248132467187938,0.007287081950601676,0.014403998832265511,0.01541725675536569,0.052400310183351596,0.04687513642594938,0.060017190899798165,0.038695373822270694,0.01902862678769316]),
    dict(E=-307.3369246897564,
         exc=[0.29258843490652453,0.3240785114648908,0.3389462708490751,0.3497422995755044,0.3533449028493544,0.3562647030986511,0.36787600312054564,0.3702561719528752,0.37108618022593565,0.37585243296130233],
         f=[0.0034638324536891696,0.0012054160015698527,0.006954565160461471,0.018365728972306504,0.038627713864741564,0.030247159864068236,0.012144611373880336,0.007382337863207703,0.10785432303657166,0.03744270731349919]),
    dict(E=-307.3358546393619,
         exc=[0.29060117428862503,0.32522538790051786,0.3423945578206376,0.34742316491642816,0.3540753791838162,0.3548535668741231,0.36491517546609,0.36994844463835047,0.3730844315926749,0.3763464902626782],
         f=[0.003336290873677106,0.00022880067153364394,0.028182142507647376,0.012462432760758223,0.03303620122677778,0.04235902298452588,0.030733597395793844,0.018623233107745565,0.10581434994636527,0.004049009605539351]),
]

solv = [
    dict(E=-1452.8624748120774,
         exc=[0.319888731199486,0.32728080410226396,0.3347492236814204,0.33595376229924884,0.33941852624201424,0.33975633766283786,0.3402791656576401,0.3406498702642388,0.34497005916118806,0.34579398678369333],
         f=[0.05233862475485776,0.006548470508760102,0.02529030812485822,0.03898148915827962,0.01743792945050656,0.06699565693602134,0.003946733344928949,0.15968065643124116,0.008626944782820247,0.03979855987434503]),
    dict(E=-1452.8619494507664,
         exc=[0.3198725075424402,0.3274009569829335,0.33407259959678126,0.3358854981043475,0.33906355351185435,0.3397425646142444,0.34042833642088133,0.3414208353006972,0.34499245294103503,0.3460125713708467],
         f=[0.05247766862027249,0.006553235827471977,0.024891210850974427,0.029625871730055254,0.01874793679303963,0.07085304771317036,0.02636239915185289,0.13602094282788005,0.01123088626797987,0.045281159339669294]),
    dict(E=-1452.8619742864082,
         exc=[0.3199584025110345,0.32731430750366913,0.3340598787643879,0.3358613621721699,0.3390439043382475,0.33977839329327003,0.34041991675561195,0.34144080469417176,0.3449997260773157,0.34603237558454425],
         f=[0.05245678518651234,0.006391446527820723,0.02481610559476556,0.02930685940557197,0.018828213551822875,0.0735741688148135,0.025962560462821645,0.1345352743645919,0.011083966062486392,0.0455198703442737]),
    dict(E=-1452.8663517898517,
         exc=[0.3274747691380418,0.3284261648874452,0.3360024563129623,0.33660063798128437,0.3369442222658531,0.3384064337942206,0.340720453869829,0.34175222182100273,0.3430546044357449,0.34600121311320653],
         f=[0.004799895512065782,0.04887405432108567,0.039728552060902755,0.03158721143059082,0.03605079589518729,0.02317362897942954,0.11216437997159082,0.07040458412385313,0.03230747935797913,0.10625515412814959]),
    dict(E=-1452.869811794463,
         exc=[0.32827455193819466,0.3346917148141172,0.3363603514691157,0.3392325629638119,0.3397281803183701,0.34035268952144027,0.3452835167707644,0.34651540745202564,0.34684828189030936,0.3474845957385291],
         f=[0.0022448642206000374,0.03238716786358395,0.04363358621071306,0.05325725833893029,0.06028427548579268,0.008029468750093048,0.0016752018987628348,0.023467996029352844,0.06278338338528211,0.01612751743587648]),
    dict(E=-1452.8650505388384,
         exc=[0.33039517270783697,0.3343578883225552,0.33735908718425217,0.3393889437556343,0.3395615375296648,0.34013291344170987,0.3404791411401428,0.34165595858479775,0.3461534437979062,0.3464012546380189],
         f=[0.006140982929764591,0.04863278445804035,0.03329508175311502,0.03094726748222668,0.04292841306170171,0.037542648020955124,0.03147629532676328,0.15228399603688836,0.006062494448048933,0.04190877066449972]),
]


def boltz_weights(confs):
    E = np.array([c['E'] for c in confs], dtype=float)
    Emin = E.min()
    rel = E - Emin
    w = np.exp(-rel / kT)
    w /= w.sum()
    return w, rel

wg, relg = boltz_weights(gas)
ws, rels = boltz_weights(solv)

# Attach weights
for c,w in zip(gas, wg):
    c['w_dft'] = float(w)
for c,w in zip(solv, ws):
    c['w_dft'] = float(w)


def spectrum(confs, sigma_ev=0.15, egrid_ev=None):
    if egrid_ev is None:
        egrid_ev = np.linspace(6.0, 12.0, 3000)
    y = np.zeros_like(egrid_ev)
    for c in confs:
        w = c['w_dft']
        exc_ev = np.array(c['exc']) * HARTREE_TO_EV
        f = np.array(c['f'])
        for Ei, fi in zip(exc_ev, f):
            y += w * fi * np.exp(-0.5*((egrid_ev - Ei)/sigma_ev)**2)
    return egrid_ev, y

Egrid_ev = np.linspace(6.0, 12.0, 4000)
Eg, yg = spectrum(gas, sigma_ev=0.15, egrid_ev=Egrid_ev)
Es, ys = spectrum(solv, sigma_ev=0.15, egrid_ev=Egrid_ev)

# Convert to wavelength axis (nm)
lambda_nm = 1239.841984 / Egrid_ev
order = np.argsort(lambda_nm)
lambda_nm = lambda_nm[order]
yg = yg[order]
ys = ys[order]

# Normalise each spectrum to max=1 for comparison of shape
if yg.max() > 0:
    yg_plot = yg/yg.max()
else:
    yg_plot = yg
if ys.max() > 0:
    ys_plot = ys/ys.max()
else:
    ys_plot = ys

fig, ax = plt.subplots(figsize=(7.2, 4.5), dpi=200)
ax.plot(lambda_nm, yg_plot, label='Gas phase (Boltzmann@DFT)', lw=2)
ax.plot(lambda_nm, ys_plot, label='15 H2O (explicit) + SMD(water) (Boltzmann@DFT)', lw=2)
ax.set_xlim(100, 220)
ax.set_xlabel('Wavelength / nm')
ax.set_ylabel('Relative absorption (a.u., normalised)')
ax.set_title('2,3-epoxybutanol TDDFT absorption: gas vs micro-solvated')
ax.legend(frameon=False)
ax.grid(True, alpha=0.25)

out = '/output_files/epoxybutanol_absorption_comparison.png'
fig.tight_layout()
fig.savefig(out)

# Print a small summary table

def summarise(confs, name):
    E = np.array([c['E'] for c in confs])
    Emin = E.min()
    print(f"{name}: N={len(confs)}")
    for i,c in enumerate(confs, start=1):
        dE_kcal = (c['E']-Emin)*627.509474
        print(f"  conf {i:2d}: dE = {dE_kcal:7.3f} kcal/mol, w = {c['w_dft']:.4f}")

summarise(gas, 'Gas phase')
summarise(solv, 'Micro-solvated+SMD')
print('Saved:', out)
