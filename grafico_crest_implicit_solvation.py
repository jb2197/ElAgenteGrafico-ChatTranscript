import numpy as np
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt

HARTREE_TO_EV = 27.211386245988
KCAL_PER_HARTREE = 627.5094740631
kB_kcal_per_mol_K = 0.00198720425864083
T = 298.15
kT = kB_kcal_per_mol_K * T


def parse_xyz(xyz_text):
    lines = [l.strip() for l in xyz_text.strip().splitlines() if l.strip()]
    # first line may be atom count
    try:
        n = int(lines[0].split()[0])
        start = 2
    except Exception:
        start = 1 if lines[0].startswith('Properties=') else 0
        # but in our case it's \"42\" then blank then atoms: keep robust
        try:
            n = int(lines[0])
            start = 2
        except Exception:
            # if it starts with comment like '42\n\nC ...'
            n = None
            start = 0
    # if first token is number and next line comment, start=2
    if n is not None:
        atom_lines = lines[start:start+n]
    else:
        atom_lines = [l for l in lines if l[0].isalpha()]
    elems = []
    coords = []
    for l in atom_lines:
        p = l.split()
        elems.append(p[0])
        coords.append([float(p[1]), float(p[2]), float(p[3])])
    return np.array(elems), np.array(coords, dtype=float)


def kabsch_rmsd(P, Q):
    # P, Q shape (N,3)
    P0 = P - P.mean(axis=0)
    Q0 = Q - Q.mean(axis=0)
    C = P0.T @ Q0
    V, S, Wt = np.linalg.svd(C)
    d = np.sign(np.linalg.det(V @ Wt))
    D = np.diag([1.0, 1.0, d])
    U = V @ D @ Wt
    P_rot = P0 @ U
    diff = P_rot - Q0
    return np.sqrt((diff**2).sum() / P.shape[0])


def cluster_conformers(confs, energy_thresh_kcal=0.05, rmsd_thresh=0.20):
    # confs: list of dicts with energy_h, xyz
    # Sort by energy
    confs_sorted = sorted(confs, key=lambda c: c['energy_h'])
    clusters = []  # each is dict with reps, total_degen
    for c in confs_sorted:
        elems_c, xyz_c = parse_xyz(c['xyz'])
        heavy_mask = elems_c != 'H'
        xyz_c_hvy = xyz_c[heavy_mask]
        placed = False
        for cl in clusters:
            rep = cl['rep']
            dE = abs((c['energy_h'] - rep['energy_h']) * KCAL_PER_HARTREE)
            if dE > energy_thresh_kcal:
                continue
            elems_r, xyz_r = parse_xyz(rep['xyz'])
            xyz_r_hvy = xyz_r[elems_r != 'H']
            if xyz_r_hvy.shape[0] != xyz_c_hvy.shape[0]:
                continue
            rmsd = kabsch_rmsd(xyz_c_hvy, xyz_r_hvy)
            if rmsd <= rmsd_thresh:
                cl['members'].append({**c, 'rmsd_to_rep': rmsd, 'dE_kcal_to_rep': dE})
                cl['degen_total'] += c.get('degen', 1)
                placed = True
                break
        if not placed:
            clusters.append({
                'rep': c,
                'members': [{**c, 'rmsd_to_rep': 0.0, 'dE_kcal_to_rep': 0.0}],
                'degen_total': c.get('degen', 1),
            })
    return clusters


def boltzmann_weights(energies_h, degeneracies=None, T=298.15):
    energies_h = np.array(energies_h, float)
    E0 = energies_h.min()
    dE_kcal = (energies_h - E0) * KCAL_PER_HARTREE
    g = np.ones_like(energies_h) if degeneracies is None else np.array(degeneracies, float)
    w_unn = g * np.exp(-dE_kcal / (kB_kcal_per_mol_K * T))
    w = w_unn / w_unn.sum()
    return w, dE_kcal


def gaussian_spectrum_eV(transitions_eV, fosc, Egrid_eV, sigma_eV=0.20):
    transitions_eV = np.asarray(transitions_eV)
    fosc = np.asarray(fosc)
    # sum f_i * exp(-(E-Ei)^2/(2 sigma^2))
    d = Egrid_eV[:, None] - transitions_eV[None, :]
    return np.sum(fosc[None, :] * np.exp(-0.5*(d/sigma_eV)**2), axis=1)


def Egrid_to_lambda_nm(Egrid_eV):
    return 1239.8419843320026 / Egrid_eV


def spectrum_vs_lambda(transitions_eV, fosc, lambda_grid_nm, sigma_eV=0.20):
    # compute spectrum in energy, then convert to lambda with Jacobian
    E = 1239.8419843320026 / lambda_grid_nm
    I_E = gaussian_spectrum_eV(transitions_eV, fosc, E, sigma_eV=sigma_eV)
    # Jacobian |dE/dλ| = hc/λ^2, with hc in eV*nm
    jac = 1239.8419843320026 / (lambda_grid_nm**2)
    return I_E * jac


# --- Input data (DFT energies and TDDFT results) ---

water_confs = [
    {
        'name': 'water_conf1', 'degen': 27,
        'energy_h': -1068.9185468526,
        'xyz': "42\n\nC 5.982129 -1.310483 0.187751\nC 6.249319 0.060817 0.172254\nH 5.433982 2.069207 0.099563\nC 4.665179 -1.781208 0.142679\nC 5.215073 0.999429 0.110470\nH 6.810456 -2.022255 0.236210\nC 3.632476 -0.856474 0.081614\nH 4.456669 -2.855385 0.155777\nC 3.917307 0.506143 0.065111\nH 7.284209 0.411524 0.209136\nC 2.132107 -1.055272 0.025354\nN 2.693404 1.218485 -0.000538\nC 1.647497 0.394569 -0.020332\nH 2.084313 -1.279974 -2.151275\nC 1.645323 -1.777807 1.293444\nC 0.327227 0.895631 -0.074256\nC 1.746135 -1.819098 -1.253487\nH 2.137546 -2.760074 1.355769\nH 1.902416 -1.204403 2.196857\nH 0.558856 -1.942351 1.279698\nH 2.231343 -2.806713 -1.239901\nH 0.660511 -1.973836 -1.325857\nH 0.178114 1.973888 -0.094549\nC -0.798302 0.100929 -0.098102\nC -2.157311 0.527555 -0.144416\nH -0.671972 -0.986290 -0.079971\nC -2.552765 1.944436 -0.173184\nC -3.145779 -0.477713 -0.160175\nH -4.299586 3.244168 -0.238935\nH -5.984577 1.412088 -0.264617\nC -3.991687 2.195001 -0.217462\nC -4.486431 -0.163143 -0.202446\nO -1.743203 2.886291 -0.161397\nH -2.847574 -1.529010 -0.138293\nC -4.914896 1.195915 -0.231566\nN -5.467268 -1.219826 -0.217082\nO -6.645832 -0.913674 -0.257919\nO -5.085392 -2.376541 -0.188224\nC 2.599044 2.668518 -0.041739\nH 2.073810 2.985879 -0.953343\nH 2.054524 3.037657 0.838843\nH 3.606477 3.096507 -0.044526\n",
        'exc_ha': [0.10662658674436815,0.1391183226342608,0.15444447091973207,0.1566099908134876,0.16287801590996442,0.1801464566264707,0.18839634542328523,0.19141742512951046,0.1970117237205754,0.19837896474416775],
        'fosc': [1.0848014696762243,4.902596486038108e-6,0.11747927368403113,7.446954279032478e-05,0.5143402895595978,0.00011299740775144422,0.01157742032901066,1.4559018909058553e-05,0.1197684463756295,0.03158089226893036],
    },
    {
        'name': 'water_conf2', 'degen': 25,
        'energy_h': -1068.9185844726856,
        'xyz': "42\n\nC 6.036440 -1.289649 -0.034261\nC 6.288633 0.084578 -0.031921\nH 5.449744 2.084850 -0.019367\nC 4.723669 -1.774040 -0.026054\nC 5.243077 1.012552 -0.021194\nH 6.873334 -1.992948 -0.042650\nC 3.679746 -0.860015 -0.015505\nH 4.527066 -2.850540 -0.027980\nC 3.949812 0.505688 -0.013021\nH 7.320461 0.446022 -0.038545\nC 2.180380 -1.074121 -0.005100\nN 2.717262 1.205746 -0.001443\nC 1.679735 0.371011 0.002418\nH 2.021649 -1.254887 -2.180689\nC 1.760704 -1.824701 1.270860\nC 0.353534 0.858852 0.011656\nC 1.741974 -1.818921 -1.278083\nH 2.262661 -2.803803 1.290814\nH 2.056471 -1.266179 2.171763\nH 0.675972 -1.997660 1.305771\nH 2.246032 -2.796578 -1.311426\nH 0.657292 -1.994718 -1.296277\nH 0.193266 1.935680 0.014636\nC -0.764253 0.052910 0.016431\nC -2.128057 0.466269 0.024401\nH -0.626536 -1.033051 0.013925\nC -2.538014 1.879356 0.028481\nC -3.106747 -0.548710 0.027979\nH -4.298568 3.161963 0.039085\nH -5.965711 1.313203 0.044926\nC -3.980038 2.115760 0.036084\nC -4.451013 -0.247280 0.035210\nO -1.737791 2.829210 0.025688\nH -2.797745 -1.597129 0.024889\nC -4.893442 1.107625 0.039291\nN -5.421487 -1.313625 0.038529\nO -6.603612 -1.018798 0.044725\nO -5.027693 -2.466682 0.035074\nC 2.607183 2.655153 0.005053\nH 2.066247 2.997016 -0.888528\nH 2.071052 2.989006 0.904488\nH 3.610113 3.093720 0.004500\n",
        'exc_ha': [0.10661718904528615,0.13910438826094654,0.15444957581804472,0.15662050291461868,0.1628765807902937,0.18014088816894017,0.18838785231649938,0.19143236799463215,0.19701324321741917,0.19837801531843227],
        'fosc': [1.0850063631782554,4.920088820116384e-06,0.11722212177879544,9.387578580442774e-07,0.5144630053723811,0.00011285931386504603,0.011384202193557104,1.3820171545990976e-05,0.12063665726948794,0.031165999079405392],
    },
    {
        'name': 'water_conf3', 'degen': 26,
        'energy_h': -1068.917086494952,
        'xyz': "42\n\nC 6.191103 -0.001478 -0.009615\nC 6.024973 -1.388490 0.011240\nH 4.632286 -3.050690 0.038426\nC 5.080196 0.849319 -0.020114\nC 4.751479 -1.965319 0.022664\nH 7.198591 0.422728 -0.018116\nC 3.812515 0.285401 -0.009023\nH 5.210798 1.935699 -0.036867\nC 3.665773 -1.098820 0.012503\nH 6.903472 -2.039307 0.018723\nC 2.444273 0.935183 -0.016920\nN 2.281762 -1.403247 0.020471\nC 1.537453 -0.297422 0.003317\nH 2.366776 1.187758 2.155995\nC 2.256855 1.757403 -1.304047\nC 0.128420 -0.353725 0.004769\nC 2.260220 1.796173 1.245187\nH 2.360199 1.121374 -2.196170\nH 1.275105 2.250232 -1.336494\nH 3.031270 2.538170 -1.344953\nH 3.034223 2.578291 1.259717\nH 1.278152 2.289041 1.265583\nH -0.329708 -1.345175 0.019213\nC -0.680702 0.762506 -0.010995\nC -2.098921 0.811266 -0.010616\nH -0.227689 1.757846 -0.025879\nC -2.714664 2.149549 -0.029218\nC -2.902510 -0.344831 0.006779\nH -4.655432 3.152644 -0.042642\nH -6.010811 1.067618 -0.011493\nC -4.176353 2.169751 -0.028722\nC -4.275296 -0.243307 0.006378\nO -2.045951 3.192915 -0.044317\nH -2.451851 -1.339841 0.020929\nC -4.919618 1.031211 -0.011722\nN -5.077648 -1.442600 0.024635\nO -6.290132 -1.326060 0.023105\nO -4.517190 -2.524240 0.040728\nC 1.749588 -2.755361 0.044069\nH 1.128055 -2.901947 0.938709\nH 1.144939 -2.940890 -0.855044\nH 2.578783 -3.469497 0.068089\n",
        'exc_ha': [0.10023559803612897,0.14373588549371372,0.1543071640764568,0.15609956927071747,0.16040106060357176,0.1795604671934776,0.18821228572817666,0.19242547068605786,0.19377728274093733,0.19710009702413062],
        'fosc': [0.9830537849220915,1.447989162101207e-06,0.2031203520657494,1.3362863086025167e-05,0.3782944064923762,9.985059539472877e-05,0.0008534615494134997,0.0024493203105877877,3.0196808731746637e-05,0.0749336246757006],
    },
    {
        'name': 'water_conf4', 'degen': 48,
        'energy_h': -1068.9158012546945,
        'xyz': "42\n\nC 6.241632 -0.627165 -0.192841\nC 5.865311 -0.525012 -1.534394\nH 4.246936 -0.226205 -2.948962\nC 5.291141 -0.506795 0.827257\nC 4.534278 -0.297548 -1.897832\nH 7.289542 -0.806424 0.061902\nC 3.967680 -0.283067 0.475670\nH 5.586375 -0.589385 1.877601\nC 3.612647 -0.177233 -0.866279\nH 6.620775 -0.626813 -2.318103\nC 2.728703 -0.116393 1.321878\nN 2.211452 0.058400 -0.953163\nC 1.655417 0.065393 0.253637\nH 2.358469 -2.263132 1.537584\nC 2.814567 1.139340 2.205433\nC 0.295336 0.224603 0.613201\nC 2.441002 -1.365129 2.168407\nH 2.994232 2.040930 1.600418\nH 1.887531 1.276736 2.782115\nH 3.647785 1.023992 2.915067\nH 3.262907 -1.515972 2.884703\nH 1.505438 -1.243056 2.734740\nH 0.103593 0.409200 1.670686\nC -0.804293 0.071391 -0.201635\nC -2.177266 0.178613 0.179637\nH -0.657293 -0.202819 -1.250060\nC -2.609771 0.518617 1.543690\nC -3.138470 -0.060309 -0.821307\nH -4.389809 0.829385 2.758596\nH -6.028097 0.396773 0.934791\nC -4.054839 0.578974 1.748058\nC -4.489267 0.018174 -0.553868\nO -1.824997 0.744127 2.480452\nH -2.812968 -0.312954 -1.833658\nC -4.952877 0.343024 0.753005\nN -5.440722 -0.230641 -1.606786\nO -6.628180 -0.153457 -1.343634\nO -5.027686 -0.508912 -2.719195\nC 1.551229 0.315858 -2.220258\nH 0.800434 1.105809 -2.086590\nH 2.297956 0.662101 -2.943875\nH 1.068870 -0.593979 -2.606626\n",
        'exc_ha': [0.10781768252292351,0.14096863397454212,0.15419869299464276,0.15671668779455228,0.16382840483259953,0.18039893135779342,0.1896584222733205,0.19085335808357953,0.19684988058427452,0.19841499639509844],
        'fosc': [1.051912287599118,0.0019974436324050795,0.18263544471142082,5.978233927350502e-05,0.4575547790617317,0.0001264221391472744,0.00963105759059053,0.0010178227359923615,0.05387982391054612,0.03795469286391339],
    },
    {
        'name': 'water_conf5', 'degen': 7,
        'energy_h': -1068.914674637559,
        'xyz': "42\n\nC 6.102684 -0.992061 -0.141651\nC 6.099637 0.390215 0.059853\nH 4.911399 2.181922 0.344506\nC 4.900437 -1.704213 -0.217769\nC 4.902475 1.100441 0.194057\nH 7.053674 -1.521497 -0.243859\nC 3.708067 -1.007011 -0.087188\nH 4.902215 -2.786557 -0.378576\nC 3.723894 0.369515 0.120291\nH 7.047682 0.932275 0.112021\nC 2.274650 -1.478698 -0.128707\nN 2.382888 0.833564 0.228438\nC 1.519180 -0.166259 0.063965\nH 2.537580 -3.013528 -1.631976\nC 1.968248 -2.446026 1.026565\nC 0.107645 -0.133774 0.058426\nC 1.924669 -2.111458 -1.483894\nH 0.911859 -2.754099 1.012558\nH 2.589825 -3.347472 0.916134\nH 2.191501 -1.985900 2.001032\nH 0.864928 -2.406169 -1.516630\nH 2.124325 -1.414379 -2.311742\nH -0.353674 -1.125129 0.043129\nC -0.712196 0.973216 -0.004547\nC -2.133552 0.990212 -0.046729\nH -0.285740 1.977121 -0.057309\nC -2.773925 2.312752 -0.146122\nC -2.915572 -0.178354 0.005681\nH -4.731239 3.275515 -0.260942\nH -6.048916 1.167926 -0.163424\nC -4.234825 2.304008 -0.186108\nC -4.290403 -0.105113 -0.035187\nO -2.124806 3.368040 -0.192459\nH -2.448705 -1.163112 0.080248\nC -4.957633 1.153092 -0.132913\nN -5.069369 -1.318003 0.021241\nO -6.283530 -1.227114 -0.019329\nO -4.489079 -2.386013 0.107234\nC 2.064536 2.216884 0.529800\nH 2.962052 2.712683 0.914995\nH 1.719758 2.747025 -0.370307\nH 1.285570 2.256058 1.303332\n",
        'exc_ha': [0.10077805224765056,0.14440726382995542,0.15408725557378739,0.1561716392725743,0.16114661000958908,0.1797159296827639,0.18923259217058608,0.1927547514942552,0.19321791959659038,0.19705468097553475],
        'fosc': [0.9718643620145917,2.6672315995133276e-05,0.207070624523988,0.0001771655163026561,0.38893160763864654,0.00010636577138512411,0.008237159796480268,0.01207276585271046,0.0002983454869024112,0.06241960875326247],
    },
]

heptane_confs = [
    {
        'name': 'heptane_conf1', 'degen': 46,
        'energy_h': -1068.91858982016,
        'xyz': "42\n\nC -6.050706 1.282205 -0.000874\nC -6.294526 -0.093547 -0.000086\nH -5.443594 -2.088968 0.001179\nC -4.740851 1.774466 -0.001055\nC -5.243533 -1.015409 0.000570\nH -6.891861 1.980456 -0.001368\nC -3.691570 0.866510 -0.000420\nH -4.550654 2.852130 -0.001690\nC -3.953293 -0.500847 0.000408\nH -7.324209 -0.461119 0.000022\nC -2.193470 1.089562 -0.000493\nN -2.716514 -1.193584 0.000977\nC -1.684204 -0.352527 0.000393\nH -2.278235 2.814011 -1.303186\nC -1.768846 1.840513 1.273586\nC -0.354994 -0.832302 0.000542\nC -1.768777 1.838980 -1.275448\nH -0.685283 2.022202 1.299500\nH -2.278447 2.815500 1.300213\nH -2.052328 1.277581 2.175697\nH -0.685188 2.020474 -1.301610\nH -2.052372 1.275046 -2.176898\nH -0.187983 -1.908124 0.000947\nC 0.757706 -0.019446 0.000127\nC 2.123998 -0.424853 0.000149\nH 0.613450 1.065684 -0.000259\nC 2.542526 -1.835423 0.000612\nC 3.096613 0.595865 -0.000327\nH 4.310792 -3.107352 0.000860\nH 5.966761 -1.248644 0.000003\nC 3.985953 -2.063081 0.000525\nC 4.442805 0.302813 -0.000376\nO 1.748028 -2.790089 0.001046\nH 2.781253 1.642395 -0.000670\nC 4.893274 -1.049423 0.000057\nN 5.406760 1.374992 -0.000873\nO 6.590663 1.087243 -0.000886\nO 5.006109 2.525707 -0.001164\nC -2.597690 -2.642325 0.002004\nH -3.597979 -3.086860 0.003472\nH -2.058076 -2.977676 -0.894819\nH -2.056192 -2.976190 0.898231\n",
        'exc_ha': [0.10663194165397023,0.139118549968274,0.15444229336222517,0.15661651504904667,0.16287594740757946,0.18014646560212788,0.18838831268281647,0.19141431899039468,0.19701275449304567,0.1983765681231504],
        'fosc': [1.0847310499579166,4.922920097371556e-06,0.1177693948007273,8.07736357613727e-07,0.5141170543079828,0.00011290957490557527,0.011457721506102678,1.3749289541562203e-05,0.12015856197276076,0.031633372017841214],
    },
    {
        'name': 'heptane_conf2', 'degen': 8,
        'energy_h': -1068.9186020573322,
        'xyz': "42\n\nC -6.060943 1.178625 -0.218882\nC -6.322122 -0.193187 -0.173517\nH -5.498198 -2.195746 -0.054006\nC -4.746181 1.656005 -0.180621\nC -5.283884 -1.125535 -0.088064\nH -6.892251 1.885462 -0.285463\nC -3.709499 0.737566 -0.096187\nH -4.542390 2.730564 -0.216895\nC -3.988400 -0.625593 -0.050400\nH -7.355365 -0.549248 -0.205318\nC -2.210244 0.944355 -0.039329\nN -2.761611 -1.330923 0.034376\nC -1.719479 -0.502100 0.038769\nH -0.636618 1.810956 -1.307851\nC -1.831955 1.734835 1.225685\nC -0.397050 -0.995472 0.108096\nC -1.722631 1.643613 -1.319907\nH -0.748092 1.903677 1.293435\nH -2.328795 2.716300 1.195970\nH -2.162440 1.207344 2.133202\nH -1.977346 1.052767 -2.212680\nH -2.216744 2.623561 -1.401583\nH -0.242854 -2.072316 0.152815\nC 0.724407 -0.194716 0.119269\nC 2.085263 -0.613415 0.181214\nH 0.592855 0.891240 0.076707\nC 2.487351 -2.027345 0.243810\nC 3.068754 0.396785 0.178878\nH 4.240037 -3.316592 0.347136\nH 5.916112 -1.476045 0.338773\nC 3.927228 -2.269700 0.300375\nC 4.410761 0.089953 0.234225\nO 1.682299 -2.973104 0.249503\nH 2.765589 1.445851 0.131883\nC 4.845550 -1.265993 0.295952\nN 5.386393 1.151462 0.229052\nO 6.566313 0.851758 0.277896\nO 4.999094 2.305556 0.176139\nC -2.661182 -2.779391 0.106013\nH -3.666795 -3.211555 0.114433\nH -2.112077 -3.164315 -0.764916\nH -2.137859 -3.075537 1.025808\n",
        'exc_ha': [0.10663766409174595,0.1391220669301627,0.154440032266648,0.15661012942127078,0.1628766876432493,0.18014248569578029,0.1883944878992655,0.1913996166302501,0.1970125682235181,0.1983756788808534],
        'fosc': [1.084690385384473,5.355678217196485e-06,0.11792719243993799,2.4707811125670596e-06,0.5139250407733894,0.00011303181160413284,0.011541537440632669,1.5110456826035433e-05,0.11975828864470991,0.03179249905937914],
    },
    {
        'name': 'heptane_conf3', 'degen': 22,
        'energy_h': -1068.917118378588,
        'xyz': "42\n\nC -6.178977 0.004542 -0.041192\nC -6.016896 1.370347 0.204004\nH -4.629215 3.008854 0.508691\nC -5.065521 -0.831492 -0.180168\nC -4.745188 1.939958 0.317744\nH -7.185162 -0.414445 -0.125604\nC -3.799543 -0.274653 -0.068865\nH -5.192826 -1.901198 -0.372678\nC -3.656842 1.088286 0.176485\nH -6.897274 2.010024 0.309426\nC -2.429635 -0.912634 -0.170872\nN -2.273579 1.389573 0.243502\nC -1.526359 0.302185 0.052938\nH -1.268796 -2.452834 0.885492\nC -2.231336 -1.519610 -1.570771\nC -0.117385 0.359829 0.072225\nC -2.251480 -1.963634 0.938902\nH -1.249097 -2.001801 -1.673287\nH -3.004930 -2.283446 -1.741373\nH -2.328125 -0.749827 -2.351276\nH -2.363709 -1.508253 1.934466\nH -3.024582 -2.738384 0.824373\nH 0.337941 1.337246 0.246599\nC 0.695197 -0.737902 -0.115514\nC 2.113760 -0.782637 -0.114089\nH 0.245840 -1.719446 -0.290953\nC 2.733774 -2.099192 -0.343419\nC 2.913556 0.357383 0.093338\nH 4.677591 -3.082538 -0.507642\nH 6.026415 -1.026399 -0.134584\nC 4.195466 -2.115703 -0.338532\nC 4.286765 0.260542 0.084522\nO 2.068276 -3.128121 -0.528935\nH 2.459843 1.336235 0.264624\nC 4.935111 -0.992956 -0.134785\nN 5.085115 1.443033 0.300357\nO 4.521094 2.506749 0.487047\nO 6.297975 1.330974 0.287857\nC -1.744732 2.720622 0.490476\nH -1.126371 2.719163 1.399193\nH -1.137452 3.052106 -0.363767\nH -2.575390 3.419903 0.628625\n",
        'exc_ha': [0.10022778908948216,0.14372926377437578,0.15427423980924065,0.15609576988760543,0.1603897536393764,0.17956055351209294,0.18820711362722345,0.19241910960986167,0.193704490243006,0.19708773156614665],
        'fosc': [0.9824257149859117,1.9530583614088874e-06,0.20407608147320958,5.332801463454183e-06,0.377772383886903,0.0001008490489886243,0.0008854003459800852,0.0024460778592700324,3.0176209729042026e-05,0.07471510712002012],
    },
    {
        'name': 'heptane_conf4', 'degen': 16,
        'energy_h': -1068.915818487836,
        'xyz': "42\n\nC -6.262190 0.550277 -0.232204\nC -5.881379 0.384769 -1.566162\nH -4.256950 0.026333 -2.959863\nC -5.314215 0.485677 0.795244\nC -4.547992 0.147431 -1.914292\nH -7.311871 0.735657 0.010565\nC -3.988427 0.252807 0.458707\nH -5.613072 0.618165 1.839437\nC -3.628924 0.082987 -0.875437\nH -6.635019 0.443912 -2.355965\nC -2.750646 0.137677 1.315221\nN -2.226188 -0.148636 -0.946826\nC -1.673581 -0.092585 0.260284\nH -2.390576 2.294664 1.414833\nC -2.831042 -1.068716 2.265133\nC -0.313433 -0.225960 0.630335\nC -2.472464 1.432251 2.093578\nH -1.906384 -1.166289 2.853611\nH -3.669344 -0.922155 2.962908\nH -2.999519 -2.003534 1.709357\nH -3.298677 1.618463 2.796449\nH -1.539250 1.345480 2.670160\nH -0.123144 -0.362085 1.695404\nC 0.786055 -0.097344 -0.188875\nC 2.159860 -0.174059 0.196717\nH 0.637046 0.131125 -1.247916\nC 2.595226 -0.452929 1.573607\nC 3.118973 0.035460 -0.812801\nH 4.378043 -0.690793 2.801157\nH 6.012456 -0.312662 0.961911\nC 4.040835 -0.486233 1.781088\nC 4.470386 -0.015078 -0.541777\nO 1.812407 -0.650721 2.518141\nH 2.791412 0.242585 -1.834771\nC 4.936811 -0.279994 0.777650\nN 5.419584 0.203211 -1.603285\nO 6.607645 0.153613 -1.336305\nO 5.004109 0.429118 -2.726681\nC -1.561973 -0.467941 -2.197736\nH -1.090627 0.424771 -2.634438\nH -0.801492 -1.239782 -2.020343\nH -2.303947 -0.863266 -2.900844\n",
        'exc_ha': [0.10787342048713114,0.14110462714202757,0.15418973659154828,0.15671370272984916,0.16388761805552685,0.18039785138563835,0.18968071314430157,0.1908698736415481,0.19685952930269934,0.19842630830786775],
        'fosc': [1.0517329536022826,0.0019296129441349213,0.18467473097352632,2.6946576794934707e-05,0.45449471344239556,0.0001260944629420806,0.009768784343662015,0.0010270765692752407,0.052517248011097785,0.039049524972473826],
    },
]


def process_solvent(confs, solvent_name):
    clusters = cluster_conformers(confs, energy_thresh_kcal=0.05, rmsd_thresh=0.20)

    reps = []
    for i, cl in enumerate(clusters, 1):
        rep = cl['rep']
        rep = {**rep, 'cluster_id': i, 'degen_cluster': cl['degen_total'], 'n_members': len(cl['members'])}
        reps.append(rep)

    energies = [r['energy_h'] for r in reps]
    degeneracies = [r['degen_cluster'] for r in reps]
    w, dE_kcal = boltzmann_weights(energies, degeneracies=degeneracies, T=T)
    for r, wi, dEi in zip(reps, w, dE_kcal):
        r['weight'] = float(wi)
        r['dE_kcal'] = float(dEi)

    reps = sorted(reps, key=lambda r: r['weight'], reverse=True)

    dominant = reps[0]

    # spectra
    lam_grid = np.linspace(200.0, 500.0, 2000)
    ens_I = np.zeros_like(lam_grid)
    for r in reps:
        trans_eV = np.array(r['exc_ha']) * HARTREE_TO_EV
        I = spectrum_vs_lambda(trans_eV, r['fosc'], lam_grid, sigma_eV=0.20)
        ens_I += r['weight'] * I

    dom_eV = np.array(dominant['exc_ha']) * HARTREE_TO_EV
    dom_I = spectrum_vs_lambda(dom_eV, dominant['fosc'], lam_grid, sigma_eV=0.20)

    # lambda max
    lam_max = float(lam_grid[np.argmax(ens_I)])
    return {
        'solvent': solvent_name,
        'clusters': clusters,
        'reps': reps,
        'dominant': dominant,
        'lambda_grid': lam_grid,
        'ensemble_I': ens_I,
        'dominant_I': dom_I,
        'lambda_max': lam_max,
    }


water = process_solvent(water_confs, 'Water (SMD)')
heptane = process_solvent(heptane_confs, 'n-Heptane (SMD)')

# Plot
plt.figure(figsize=(7.2, 4.6))
plt.plot(water['lambda_grid'], water['ensemble_I']/water['ensemble_I'].max(), label='Ensemble (Water)', color='C0', lw=2)
plt.plot(heptane['lambda_grid'], heptane['ensemble_I']/heptane['ensemble_I'].max(), label='Ensemble (n-Heptane)', color='C3', lw=2)
plt.plot(water['lambda_grid'], water['dominant_I']/water['ensemble_I'].max(), label=f"Dominant conf (Water)", color='C0', lw=1.5, ls='--')
plt.plot(heptane['lambda_grid'], heptane['dominant_I']/heptane['ensemble_I'].max(), label=f"Dominant conf (n-Heptane)", color='C3', lw=1.5, ls='--')
plt.gca().invert_xaxis()
plt.xlabel('Wavelength / nm')
plt.ylabel('Normalized absorbance (a.u.)')
plt.title('Boltzmann-weighted TDDFT absorption spectra\n(wB97X-d4/def2-SVP, Gaussian broadening σ=0.20 eV)')
plt.legend(frameon=False, fontsize=8)
plt.tight_layout()

outpath = '/output_files/absorption_water_vs_heptane.svg'
plt.savefig(outpath, format='svg')

# Create summary tables

def make_weight_table(sol):
    rows = []
    for r in sol['reps']:
        rows.append((r['cluster_id'], r['n_members'], r['degen_cluster'], r['dE_kcal'], r['weight'], r['energy_h']))
    return rows

summary = {
    'water_lambda_max_nm': water['lambda_max'],
    'heptane_lambda_max_nm': heptane['lambda_max'],
    'water_reps': make_weight_table(water),
    'heptane_reps': make_weight_table(heptane),
    'water_n_clusters': len(water['reps']),
    'heptane_n_clusters': len(heptane['reps']),
    'svg_path': outpath,
    'water_dominant_cluster': water['dominant']['cluster_id'],
    'heptane_dominant_cluster': heptane['dominant']['cluster_id'],
}

summary
